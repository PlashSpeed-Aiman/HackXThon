<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AvaloniaApplication1.ViewModels"
             xmlns:converters="using:AvaloniaApplication1.Converters.Common"
             xmlns:models="using:AvaloniaApplication1.Models"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="AvaloniaApplication1.Views.BreathingView"
             x:DataType="vm:BreathingViewModel">

    <UserControl.Resources>
        <converters:AngleToArcConverter x:Key="AngleToArcConverter" />
    </UserControl.Resources>

    <Grid Background="#F0F8FF">
        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="40">

            <!-- Header -->
            <StackPanel Spacing="10" HorizontalAlignment="Center">
                <TextBlock Text="Deep Breathing to Deploy"
                           FontSize="36"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="#2C5F7F" />
                <TextBlock Text="Complete 3 breathing cycles to unlock the Deploy button"
                           FontSize="14"
                           Foreground="#666"
                           HorizontalAlignment="Center" />
            </StackPanel>

            <!-- Breathing Circle Animation with Visual Effects -->
            <Grid Width="400" Height="400" HorizontalAlignment="Center" ClipToBounds="True">

                <!-- Layer 1: Background progress ring (gray) -->
                <Ellipse Width="180" Height="180"
                         HorizontalAlignment="Center" VerticalAlignment="Center"
                         Stroke="#E0E0E0"
                         StrokeThickness="6"
                         Fill="Transparent" />

                <!-- Layer 2: Particle effects -->
                <ItemsControl ItemsSource="{Binding Particles}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="models:BreathingParticle">
                            <Ellipse Width="{Binding Size}"
                                     Height="{Binding Size}"
                                     Fill="{Binding Color}"
                                     Opacity="{Binding Opacity}"
                                     Canvas.Left="{Binding X}"
                                     Canvas.Top="{Binding Y}" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Layer 3: Animated progress arc -->
                <Canvas>
                    <Path Stroke="{Binding ProgressRingColor}"
                          StrokeThickness="6"
                          StrokeLineCap="Round"
                          Fill="Transparent"
                          Data="{Binding ProgressAngle, Converter={StaticResource AngleToArcConverter}}" />
                </Canvas>

                <!-- Layer 4: Breathing circle with glow (consolidated) -->
                <Border Width="{Binding CircleSize}" Height="{Binding CircleSize}"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        CornerRadius="{Binding CircleCornerRadius}"
                        Background="Transparent"
                        BoxShadow="{Binding BoxShadowString}">
                    <Border.OpacityMask>
                        <RadialGradientBrush>
                            <GradientStop Color="White" Offset="0" />
                            <GradientStop Color="White" Offset="1" />
                        </RadialGradientBrush>
                    </Border.OpacityMask>
                    
                    <Grid>
                        <!-- Glow effect layer -->
                        <Ellipse Fill="Transparent"
                                 Opacity="{Binding GlowIntensity}" />

                        <!-- Main circle -->
                        <Ellipse Fill="{Binding CircleFillColor}"
                                 Stroke="{Binding CircleStrokeColor}"
                                 StrokeThickness="3"
                                 Opacity="0.7" />
                    </Grid>
                </Border>
            </Grid>

            <!-- Instruction Text -->
            <TextBlock Text="{Binding InstructionText}"
                       FontSize="24"
                       FontWeight="SemiBold"
                       HorizontalAlignment="Center"
                       Foreground="#2C5F7F" />

            <!-- Progress Info -->
            <TextBlock HorizontalAlignment="Center"
                       FontSize="16"
                       Foreground="#555">
                <Run Text="Cycles Completed: " />
                <Run Text="{Binding CyclesCompleted}" FontWeight="Bold" />
                <Run Text=" / " />
                <Run Text="{Binding RequiredCyclesCount}" FontWeight="Bold" />
            </TextBlock>

            <!-- Control Buttons -->
            <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center">
                <Button Content="Start Breathing"
                        Command="{Binding StartBreathingCommand}"
                        IsVisible="{Binding !IsBreathing}"
                        Padding="25,12"
                        FontSize="16"
                        Background="#4682B4"
                        Foreground="White"
                        CornerRadius="20" />

                <Button Content="Stop"
                        Command="{Binding StopBreathingCommand}"
                        IsVisible="{Binding IsBreathing}"
                        Padding="25,12"
                        FontSize="16"
                        Background="#DC143C"
                        Foreground="White"
                        CornerRadius="20" />
            </StackPanel>

            <!-- Deploy Button (Unlocked after 3 cycles) -->
            <Button Content="Deploy to Production"
                    Command="{Binding DeployCommand}"
                    IsEnabled="{Binding IsDeployEnabled}"
                    Padding="40,15"
                    FontSize="18"
                    FontWeight="Bold"
                    Background="#28A745"
                    Foreground="White"
                    CornerRadius="25"
                    HorizontalAlignment="Center">
                <Button.Styles>
                    <Style Selector="Button:disabled">
                        <Setter Property="Background" Value="#CCCCCC" />
                        <Setter Property="Foreground" Value="#888888" />
                    </Style>
                </Button.Styles>
            </Button>

            <!-- Deploy Confirmation Message -->
            <Border IsVisible="{Binding ShowDeployConfirmation}"
                    Background="#E8F5E9"
                    BorderBrush="#4CAF50"
                    BorderThickness="2"
                    CornerRadius="10"
                    Padding="30,20"
                    MaxWidth="500"
                    HorizontalAlignment="Center">
                <TextBlock Text="{Binding DeployMessage}"
                           FontSize="18"
                           FontStyle="Italic"
                           TextAlignment="Center"
                           TextWrapping="Wrap"
                           Foreground="#2E7D32" />
            </Border>

        </StackPanel>
    </Grid>
</UserControl>
